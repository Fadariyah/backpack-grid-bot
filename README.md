# Backpack กลยุทธ์ทำตลาดด้วย Bollinger Bands
นี่คือกลยุทธ์กริดเทรดดิ้งแบบปรับปรุงสำหรับ **Backpack Exchange** ที่ใช้ *Bollinger Bands สองชุด* เพื่อควบคุมขนาดสถานะและช่วยตัดสินแนวโน้ม ทำให้ปรับตัวได้กับสภาพตลาดที่ต่างกัน

## จุดเด่นของกลยุทธ์
- **Bollinger Bands สองชุด**
  - ชุดระยะยาว สำหรับบริหารขนาดสถานะ (ค่าเริ่มต้น 1 ชั่วโมง)
  - ชุดระยะสั้น สำหรับวิเคราะห์แนวโน้ม (ค่าเริ่มต้น 5 นาที)
- **บริหารสถานะแบบไดนามิก**
  - ราคายิ่งต่ำ ขนาดสถานะฝั่งซื้อยิ่งมาก
  - ราคายิ่งสูง ขนาดสถานะฝั่งซื้อยิ่งน้อย
  - ปรับขนาดออร์เดอร์ตามตำแหน่งบน Bollinger Band แบบอัตโนมัติ
- **ปรับตัวตามแนวโน้ม**
  - เลือกให้ “ซื้อเฉพาะใต้เส้นค่าเฉลี่ย (SMA)” ได้
  - ตั้ง “ระยะกำไรขั้นต่ำ (min profit spread)” เพื่อหลีกเลี่ยงการขายเร็วเกินไป
  - หยุดเทรดอัตโนมัติเมื่อเจอแนวโน้มแรง
- **บริหารสเปรดแบบไดนามิก**
  - ปรับสเปรดซื้อ–ขายตามความผันผวนของตลาด
  - รองรับ “แนวโน้มเอนเอียง (trend skew)”
    - ขาขึ้น ลดสเปรดฝั่งขาย
    - ขาลง ลดสเปรดฝั่งซื้อ
- **ควบคุมความเสี่ยงครบถ้วน**
  - ติดตามต้นทุนถือครองแบบเรียลไทม์
  - ปรับขนาดสถานะแบบไดนามิก
  - รองรับกรณีมีการกู้ยืม (margin/借贷) ในการคำนวณบาลานซ์
  - ป้องกันด้วยเพดานขนาดออร์เดอร์
  - มีทั้งกลไก Stop-Loss และ Take-Profit

## ความต้องการในการติดตั้ง
- Python 3.10+
- ไพธอนแพ็กเกจที่ใช้:
  - `requests`
  - `numpy`
  - `python-dotenv` (สำหรับจัดการตัวแปรสิ่งแวดล้อม)
  - `sqlite3` (เก็บข้อมูลโลคอล)
  - `websocket-client` (สมัครรับข้อมูลแบบเรียลไทม์)

## เริ่มต้นอย่างรวดเร็ว
1) โคลนโปรเจ็กต์
```bash
git clone https://github.com/Fadariyah/backpack-grid-bot.git
cd backpack-grid
```

2) ติดตั้ง dependencies
```bash
uv sync
```
ถ้ายังไม่มี `uv` ให้ติดตั้งก่อน:
```bash
curl -LsSf https://astral.sh/uv/install.sh | sh
```

3) ตั้งค่า API Key
- สร้างไฟล์ `.env`
- ใส่คีย์ Backpack ของคุณ:
```env
BACKPACK_API_KEY=ใส่คีย์ของคุณ
BACKPACK_SECRET_KEY=ใส่ซีเคร็ตของคุณ
```

4) ตั้งค่าพารามิเตอร์กลยุทธ์ (ใน `config.py`)
```python
# การตั้งค่าการเทรด
SYMBOL = "SOL_USDC"          # คู่เทรด
ORDER_AMOUNT = 4             # ยอดสั่งต่อครั้ง (USDC)
GRID_TOTAL_INVESTMENT = 400  # เงินลงทุนรวม (USDC)

# พารามิเตอร์ Bollinger Band
LONG_BOLL_INTERVAL = "1h"    # ไทม์เฟรมระยะยาว
LONG_BOLL_PERIOD = 21        # จำนวนแท่งสำหรับคำนวณระยะยาว
LONG_BOLL_STD = 2.0          # ส่วนเบี่ยงเบนมาตรฐาน (เท่า)
SHORT_BOLL_INTERVAL = "5m"   # ไทม์เฟรมระยะสั้น
SHORT_BOLL_PERIOD = 21       # จำนวนแท่งสำหรับคำนวณระยะสั้น
SHORT_BOLL_STD = 2.0         # ส่วนเบี่ยงเบนมาตรฐาน (เท่า)

# ควบคุมขนาดสถานะ
MAX_POSITION_SCALE = 10.0    # ตัวคูณขนาดสถานะสูงสุด
MIN_POSITION_SCALE = 1.0     # ตัวคูณขนาดสถานะต่ำสุด
MIN_PROFIT_SPREAD = 0.001    # สเปรดกำไรขั้นต่ำ (0.1%)
TRADE_IN_BAND = True         # เทรดเฉพาะภายในแบนด์
BUY_BELOW_SMA = True         # ซื้อเฉพาะเมื่อราคาต่ำกว่า SMA

# สเปรดแบบไดนามิก
DYNAMIC_SPREAD = True
SPREAD_MIN = 0.001           # สเปรดต่ำสุด 0.1%
SPREAD_MAX = 0.002           # สเปรดสูงสุด 0.2%

# แนวโน้มเอนเอียง (Trend Skew)
TREND_SKEW = True
UPTREND_SKEW = 0.8           # ขาขึ้น ลดสเปรดฝั่งขาย
DOWNTREND_SKEW = 1.2         # ขาลง ลดสเปรดฝั่งซื้อ

# การควบคุมความเสี่ยง
STOP_LOSS_ACTIVATION = 0.02  # เริ่มเฝ้าระวัง Stop-Loss เมื่อขาดทุนถึง 2%
STOP_LOSS_RATIO = 0.03       # ตัดขาดทุนที่ 3%
TAKE_PROFIT_RATIO = 0.07     # ทำกำไรที่ 7%

# ความละเอียดคำสั่ง
PRICE_PRECISION = 2
QUANTITY_PRECISION = 2

# ขนาดออร์เดอร์
BASE_ORDER_SIZE = 0.02       # ขนาดพื้นฐาน (หน่วยเหรียญฐาน เช่น SOL)
QUOTE_ORDER_SIZE = 4         # ขนาดพื้นฐาน (หน่วยเหรียญอ้างอิง เช่น USDC)
```

5) รันกลยุทธ์
```bash
uv run grid_bot.py
```

## อธิบายพารามิเตอร์
### พารามิเตอร์ Bollinger Band
1. **ระยะยาว** (`LONG_BOLL_INTERVAL`, `LONG_BOLL_PERIOD`, `LONG_BOLL_STD`)
   - ใช้บริหาร “ขนาดสถานะรวม”
   - 21 แท่ง, ไทม์เฟรม 1 ชั่วโมง เหมาะกับการดูแนวโน้มกลาง–ยาว
   - ส่วนเบี่ยงเบนมาตรฐาน 2.0 ปรับเพิ่ม–ลดตามความผันผวนได้

2. **ระยะสั้น** (`SHORT_BOLL_INTERVAL`, `SHORT_BOLL_PERIOD`, `SHORT_BOLL_STD`)
   - ใช้จับจังหวะและแนวโน้มระยะสั้น
   - 21 แท่ง, ไทม์เฟรม 5 นาที เหมาะกับการเก็บความผันผวนสั้น
   - ใช้หน้าต่างเท่ากัน (21) เพื่อความสอดคล้องของอินดิเคเตอร์
   - หากราคาทะลุแบนด์ระยะสั้น จะ “พักการเทรดชั่วคราว”

### การควบคุมสถานะ
1. **ตัวคูณสถานะ** (`MAX_POSITION_SCALE`, `MIN_POSITION_SCALE`)
   - คุมจำนวนซื้อในตำแหน่งราคาที่ต่างกัน
   - ถือครองสูงสุดไม่เกิน 10 เท่าของออร์เดอร์พื้นฐาน เพื่อลดความเสี่ยง
   - ต่ำสุดคือขนาดออร์เดอร์พื้นฐาน เพื่อรักษาความต่อเนื่องของตลาด

2. **การควบคุมกำไรขั้นต่ำ** (`MIN_PROFIT_SPREAD`)
   - กำหนดสเปรดกำไรขั้นต่ำที่ 0.1%
   - ช่วยรักษาโอกาสกำไรโดยไม่เสียโอกาส Fill
   - เลี่ยงสเปรดกว้างเกินไปที่ทำให้ทำตลาดไม่มีประสิทธิภาพ

3. **การควบคุมการเทรด** (`TRADE_IN_BAND`, `BUY_BELOW_SMA`)
   - `TRADE_IN_BAND`: เทรดเฉพาะในขอบเขต Bollinger เพื่อลดความเสี่ยง
   - `BUY_BELOW_SMA`: ซื้อเฉพาะใต้ SMA เพื่อหลีกเลี่ยงการไล่ราคา

4. **การควบคุมออร์เดอร์**
   - `BASE_ORDER_SIZE`: ขนาดฐาน (เหรียญฐาน)
   - `QUOTE_ORDER_SIZE`: ขนาดฐาน (เหรียญอ้างอิง)
   - ระบบจะ “ขยาย/หด” ขนาดคำสั่งตามตัวคูณสถานะ แต่ **ไม่เกิน 5×** ของขนาดฐาน

### สเปรดแบบไดนามิก
1. **คุมสเปรด** (`DYNAMIC_SPREAD`, `SPREAD_MIN`, `SPREAD_MAX`)
   - ปรับสเปรดอัตโนมัติจากความผันผวน
   - ผันผวนต่ำ → ใช้สเปรดต่ำสุด (0.1%)
   - ผันผวนสูง → ใช้สเปรดสูงสุด (0.2%)
   - ช่วงกลางคำนวณแบบ *linear interpolation*

2. **แนวโน้มเอนเอียง** (`TREND_SKEW`, `UPTREND_SKEW`, `DOWNTREND_SKEW`)
   - แบ่งสัดส่วนสเปรดซื้อ–ขายตามทิศทางแนวโน้ม
   - ขาขึ้น: ลดสเปรด **ฝั่งขาย** (เช่น 0.8) เพิ่มสเปรดฝั่งซื้อ
   - ขาลง: ลดสเปรด **ฝั่งซื้อ** (เช่น 1.2) เพิ่มสเปรดฝั่งขาย
   - ปรับ “แรง” ได้ด้วยค่าตัวคูณ

### การควบคุมความเสี่ยง
1. **Stop-Loss** (`STOP_LOSS_ACTIVATION`, `STOP_LOSS_RATIO`)
   - เริ่มเฝ้าระวังที่ขาดทุน 2%
   - ตัดขาดทุนที่ 3% ด้วยคำสั่งตลาด (*market order*)

2. **Take-Profit** (`TAKE_PROFIT_RATIO`)
   - ทำกำไรที่ 7% ด้วยคำสั่งตลาด
   - เน้น “ล็อกกำไร” เพื่อลดโอกาสโดนดึงกลับ

## ลอจิกของกลยุทธ์
1. **การคำนวณสถานะ**
   - รวมสัญญาณจาก Bollinger ระยะยาว–สั้น เพื่อคำนวณ “เป้าหมายขนาดสถานะ”
   - ปรับขนาดออร์เดอร์แบบไดนามิก สูงสุดไม่เกิน 5× ของขนาดฐาน
   - พิจารณา “ต้นทุนเฉลี่ยถือครอง” ประกอบการตัดสินใจ

2. **เงื่อนไขการเทรด**
   - **ซื้อ**: ราคาอยู่ในแบนด์ระยะสั้น (ถ้าเปิดใช้), ราคาอยู่ใต้ SMA ระยะยาว (ถ้าเปิดใช้), และมีเงินเหรียญอ้างอิงเพียงพอ
   - **ขาย**: ราคา > ต้นทุนถือครอง + สเปรดกำไรขั้นต่ำ, ราคาอยู่ในแบนด์ (ถ้าเปิดใช้), และมีเหรียญฐานเพียงพอ

3. **การบริหารความเสี่ยง**
   - ติดตามต้นทุนและจำนวนถือครองแบบเรียลไทม์
   - เพดานขนาดออร์เดอร์เพื่อป้องกันความเสี่ยง
   - หยุดเทรดชั่วคราวเมื่อเจอ “แนวโน้มแรงผิดปกติ”
   - คำนวณบาลานซ์โดยคำนึงถึงสถานะกู้ยืม
   - มีกลไกทั้ง Stop-Loss และ Take-Profit

## การจัดเก็บข้อมูล
กลยุทธ์ใช้ฐานข้อมูล **SQLite** เพื่อบันทึก
- ข้อมูลสถานะ (positions)
- ประวัติคำสั่งซื้อขาย (trades)
- การคำนวณต้นทุน

ไฟล์ฐานข้อมูลอยู่ที่ `data/positions.db`

## สถานการณ์ที่เหมาะสม
1. **ตลาดแกว่ง (Sideways/Range)**
   - ทำกำไรจากส่วนต่างราคา (market making)
   - ปรับขนาดสถานะเพื่อลดความเสี่ยง
   - สเปรดแบบไดนามิกที่สอดคล้องกับความผันผวน

2. **ตลาดขาลง**
   - ทยอยสะสมเพื่อลดต้นทุนเฉลี่ย
   - ทำกำไรบางส่วนเมื่อดีดกลับ
   - มี Stop-Loss ป้องกันการดึงลงลึก

3. **ตลาดขาขึ้น**
   - รักษาสถานะเล็กเพื่อทำตลาดต่อเนื่อง
   - ตั้งสเปรดกำไรขั้นต่ำ
   - ใช้ Take-Profit เพื่อล็อกผลกำไร

## คำเตือนความเสี่ยง
- โปรเจ็กต์นี้เพื่อการศึกษาและวิจัยเท่านั้น
- ควรทดสอบอย่างครบถ้วนก่อนใช้งานจริง
- จัดการความเสี่ยงอย่างเหมาะสมและตั้งค่าพารามิเตอร์ให้รอบคอบ
- ตลาดมีความเสี่ยง การลงทุนต้องใช้วิจารณญาณ

## ใบอนุญาต
MIT License
